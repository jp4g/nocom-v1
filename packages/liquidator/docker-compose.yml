version: '3.8'

services:
  # Unified Liquidator Service
  # Combines price monitoring, position tracking, and liquidation execution
  liquidator:
    # build:
    #   context: ../..
    #   dockerfile: packages/liquidator/Dockerfile
    image: 0xjp4g/nocom-liquidator:latest
    container_name: liquidator
    ports:
      - "9000:9000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # CoinGecko API Configuration
      - COINGECKO_API_KEY=${COINGECKO_API_KEY}

      # Aztec Node URL
      - AZTEC_NODE_URL=${AZTEC_NODE_URL:-http://host.docker.internal:8080}

      # Price monitoring configuration
      - PRICE_UPDATE_INTERVAL=${PRICE_UPDATE_INTERVAL:-60000}
      - PRICE_CHANGE_THRESHOLD=${PRICE_CHANGE_THRESHOLD:-0.5}
      - MAX_UPDATE_INTERVAL=${MAX_UPDATE_INTERVAL:-1800000}
      - MAX_TRACKED_ASSETS=${MAX_TRACKED_ASSETS:-50}

      # Sync configuration
      - SYNC_INTERVAL=${SYNC_INTERVAL:-60000}

      # API configuration
      - LIQUIDATOR_PORT=9000
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - liquidator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:9000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  liquidator-network:
    driver: bridge
    name: liquidator-network
