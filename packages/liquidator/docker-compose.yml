version: '3.8'

services:
  # Price Service - Public API for price tracking and updates
  price-service:
    image: 0xjp4g/price-service:latest
    container_name: liquidator-price-service
    ports:
      - "9000:9000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # CoinGecko API Configuration
      - COINGECKO_API_KEY=${COINGECKO_API_KEY}

      # Aztec Node URL (each service hosts its own PXE)
      - AZTEC_NODE_URL=${AZTEC_NODE_URL:-http://host.docker.internal:8080}

      # Price monitoring configuration
      - PRICE_UPDATE_INTERVAL=${PRICE_UPDATE_INTERVAL:-60000}
      - PRICE_CHANGE_THRESHOLD=${PRICE_CHANGE_THRESHOLD:-0.5}
      - MAX_UPDATE_INTERVAL=${MAX_UPDATE_INTERVAL:-1800000}
      - MAX_TRACKED_ASSETS=${MAX_TRACKED_ASSETS:-50}

      # Oracle contract configuration (mocked)
      - ORACLE_CONTRACT_ADDRESS=${ORACLE_CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000000}

      # Internal service URLs - now points to sentinel
      - NOTE_MONITOR_URL=http://liquidation-sentinel:9001
      - LIQUIDATION_API_KEY=${LIQUIDATION_API_KEY:-default_api_key_change_me}

      # API configuration
      - PRICE_SERVICE_API_PORT=9000
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - liquidator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:9000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Liquidation Sentinel - Monitors positions and executes liquidations
  liquidation-sentinel:
    # build:
    #   context: ../..
    #   dockerfile: packages/liquidator/services/liquidation-sentinel/Dockerfile
    image: 0xjp4g/liquidation-sentinel:latest
    container_name: liquidator-sentinel
    ports:
      - "9001:9001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Aztec Node URL
      - AZTEC_NODE_URL=${AZTEC_NODE_URL:-http://host.docker.internal:8080}

      # Price service URL for initial price fetch
      - PRICE_SERVICE_URL=http://price-service:9000

      # Sync configuration
      - SYNC_INTERVAL=${SYNC_INTERVAL:-60000}

      # API configuration
      - SENTINEL_API_PORT=9001
      - PRICE_SERVICE_API_KEY=${LIQUIDATION_API_KEY:-default_api_key_change_me}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - liquidator-network
    restart: unless-stopped
    depends_on:
      price-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:9001/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  liquidator-network:
    driver: bridge
    name: liquidator-network
